
---

# 16.3.1: Configure a ZPF

Configuring a ZPF follows a logical, multi-step process that uses the Cisco Common Classification Policy Language (C3PL) framework. While the exact order can vary, there are dependencies between the steps.

#### The 5 Steps of ZPF Configuration

This process is used to achieve a goal, such as allowing HTTP traffic from a private zone to a public zone while blocking all other traffic.

| Step | Action | Description |
| :--- | :--- | :--- |
| **1** | **Create the Zones** | Logically group interfaces with similar security requirements. For example, create an `IN-ZONE` and an `OUT-ZONE`. |
| **2** | **Create a Class-Map** | **Identify** the "interesting" traffic you want to apply a policy to. This is where you specify the protocol (e.g., HTTP, ICMP). |
| **3** | **Create a Policy-Map** | **Define the action** to take on the traffic identified by the class-map. The actions are `inspect`, `pass`, or `drop`. |
| **4** | **Create a Zone-Pair & Apply Policy** | Define the direction of traffic flow by creating a **zone-pair** (e.g., from `IN-ZONE` to `OUT-ZONE`) and then attach the policy-map to it. |
| **5** | **Assign Interfaces to Zones** | The final step that activates the firewall. Assign the physical or virtual interfaces to their respective security zones. |

#### Important Note on Configuration Order
You cannot configure a step that relies on a component that hasn't been created yet. The logical dependency is:
1.  A `class-map` must exist **before** it can be used in a `policy-map`.
2.  A `policy-map` must exist **before** it can be attached to a `zone-pair`.


---

# 16.3.2: Step 1. Create the Zones

#### Pre-Configuration Planning
Before typing any commands, answer these key design questions:
1.  **Which interfaces** will belong to each zone?
2.  What are the descriptive **names** for each zone? (e.g., `PRIVATE`, `PUBLIC`, `DMZ`)
3.  What **traffic flow** needs to be permitted between the zones, and in which direction?

#### The Configuration Command
The first configuration step is to declare the existence of your logical zones.

*   **Command:** `zone security [zone-name]`
    *   This command creates the zone and enters the zone security configuration mode `(config-sec-zone)#`.
    *   You typically just `exit` this mode, as the configuration happens elsewhere.

#### Example
Based on the common topology of an internal LAN and the internet, two zones are created:

*   **PRIVATE:** For the internal, trusted network.
*   **PUBLIC:** For the external, untrusted network.

```
! Create the zone for the internal LAN
R1(config)# zone security PRIVATE
R1(config-sec-zone)# exit

! Create the zone for the internet
R1(config)# zone security PUBLIC
R1(config-sec-zone)# exit
```
**Result:** The router is now aware of two logical security zones, `PRIVATE` and `PUBLIC`.


---

# 16.3.3: Step 2. Identify Traffic with a Class-Map

#### Core Concept
A **Class-Map** is a tool used to **identify** or **classify** specific types of traffic. It answers the question, *"What traffic am I interested in?"* Before you can apply an action (like `inspect` or `drop`), you first have to define what traffic that action applies to.

---
#### Key Parameters

| Parameter          | Description                                                                                                                      |
| :----------------- | :------------------------------------------------------------------------------------------------------------------------------- |
| **`type inspect`** | **CRITICAL:** This keyword specifies that the class-map will be used for ZPF security purposes, not for other features like QoS. |
| **`match-any`**    | The packet must match **at least one** of the `match` statements in the class-map. (Logical OR).                                 |
| **`match-all`**    | The packet must match **all** of the `match` statements in the class-map. (Logical AND). `match-any` is far more common.         |

---
#### Configuration Commands

1.  **Create the Class-Map:**
    ```
    Router(config)# class-map type inspect [match-any | match-all] [CLASS-MAP-NAME]
    ```

2.  **Define Match Criteria (inside `config-cmap` mode):**
    *   **Match by Protocol (most common):**
        `match protocol [protocol-name]`
    *   **Match by ACL (for more specific rules):**
        `match access-group [acl-name | acl-#]`
    *   **Match another Class-Map (for nested logic):**
        `match class-map [another-class-map-name]`

---
#### Practical Example

*   **Goal:** Create a class-map to identify all traffic necessary for basic web browsing.
*   **Implementation:** We create a class-map named `HTTP-TRAFFIC` that uses `match-any` logic.
*   **Best Practice:** When permitting web traffic, you must also permit DNS, because a browser needs to resolve a domain name (e.g., cisco.com) into an IP address before it can establish an HTTP/HTTPS session.

```
! Create the class-map for web browsing traffic
R1(config)# class-map type inspect match-any HTTP-TRAFFIC

! Define the protocols that constitute "web browsing"
R1(config-cmap)# match protocol http
R1(config-cmap)# match protocol https
R1(config-cmap)# match protocol dns
```


---

# 16.3.4: Step 3. Define an Action with a Policy-Map

#### Core Concept
A **Policy-Map** is where you define the **action** that will be applied to the traffic identified by a `class-map`. It answers the question, *"Now that I've identified the traffic, what should I do with it?"* A policy-map is a container that links one or more class-maps to their respective actions.

---
#### Configuration Commands
The configuration involves three nested levels:

1.  **Create the Policy-Map:**
    `R1(config)# policy-map type inspect [POLICY-MAP-NAME]`

2.  **Associate a Class-Map:** (Inside `config-pmap` mode)
    `R1(config-pmap)# class type inspect [CLASS-MAP-NAME]`

3.  **Define the Action:** (Inside `config-pmap-c` mode)
    `R1(config-pmap-c)# {inspect | drop | pass}`

---
#### Practical Example

*   **Goal:** Create a policy named `PRIV-TO-PUB-POLICY` that will apply the `inspect` action to the web traffic we previously identified in the `HTTP-TRAFFIC` class-map.

```
! Create the policy-map
R1(config)# policy-map type inspect PRIV-TO-PUB-POLICY

! Associate the class-map that identifies web traffic
R1(config-pmap)# class type inspect HTTP-TRAFFIC

! Define the action to take on that traffic
R1(config-pmap-c)# inspect
```

---
#### Understanding the Actions

| Action      | Description                                                                                                                   | Key Feature / Consequence                                                                                                                                                             |
| :---------- | :---------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`inspect`** | **Stateful Inspection.** This is the most common and powerful action.                                                           | It creates a session in the state table and **automatically permits the return traffic** for that specific session.                                                                   |
| **`drop`**    | Explicitly denies the traffic.                                                                                                | Packets are silently discarded (no ICMP unreachable message is sent). **This is the default action for any traffic that doesn't match a class in the policy (`class-default`)**. |
| **`pass`**    | **Stateless Permit.** Forwards the traffic in one direction only.                                                               | It does **not** create a session or track the connection. You would need to configure a separate, reverse policy to allow the return traffic. Rarely used.                         |


---

# 16.3.5: Step 4. Create a Zone-Pair and Apply the Policy

#### Core Concept
A **Zone-Pair** is what defines the **direction** of the traffic flow that you want to control. After creating a `policy-map` (the action), you must apply it to a specific zone-pair to make it active. This step answers the question, *"Where does this policy apply?"*

---
#### Configuration Commands
This is a two-part process within the configuration:

1.  **Create the Zone-Pair:**
    *   This command defines a unidirectional flow from a source zone to a destination zone.
    ```
    Router(config)# zone-pair security [ZONE-PAIR-NAME] source [SOURCE-ZONE] destination [DEST-ZONE]
    ```

2.  **Apply the Policy to the Zone-Pair:**
    *   Inside the zone-pair sub-configuration mode `(config-sec-zone-pair)#`, you attach the policy-map you created in Step 3.
    ```
    Router(config-sec-zone-pair)# service-policy type inspect [POLICY-MAP-NAME]
    ```

---
#### Practical Example

*   **Goal:** Apply our web inspection policy (`PRIV-TO-PUB-POLICY`) to all traffic moving from the `PRIVATE` zone to the `PUBLIC` zone.

```
! 1. Create the zone-pair and define the direction of traffic
R1(config)# zone-pair security PRIV-PUB source PRIVATE destination PUBLIC

! 2. Attach the policy-map (which contains the 'inspect' action for web traffic) to this zone-pair
R1(config-sec-zone-pair)# service-policy type inspect PRIV-TO-PUB-POLICY
```

#### Summary of the Relationship

| Component | Name in Example | Role |
| :--- | :--- | :--- |
| **Source Zone** | `PRIVATE` | Where the traffic originates. |
| **Destination Zone** | `PUBLIC` | Where the traffic is going. |
| **Zone-Pair** | `PRIV-PUB` | Defines the `PRIVATE -> PUBLIC` traffic flow. |
| **Policy-Map** | `PRIV-TO-PUB-POLICY`| Defines the action (`inspect`) that will be applied to this flow. |


---

# 16.3.6: Step 5. Assign Zones to Interfaces

#### Core Concept
This is the final and most critical step. It **activates** the firewall by assigning the physical router interfaces to the logical security zones you created. Until this step is completed, the firewall policy is just a configuration in memory and is not actively filtering any traffic.

**CRITICAL WARNING:** Once an interface is made a member of a zone, it immediately falls under the ZPF rules. If you have not yet configured a policy to permit traffic, all traffic attempting to cross a zone boundary will be **dropped**.

---
#### The Configuration Command
This command is applied in interface configuration mode.

*   **Command:** `zone-member security [zone-name]`

---
#### Practical Example
Based on the previous steps, we now assign the router's LAN and WAN interfaces to their respective zones.

*   **Goal:**
    *   Assign the LAN interface (`GigabitEthernet 0/0`) to the `PRIVATE` zone.
    *   Assign the Internet interface (`Serial 0/0/0`) to the `PUBLIC` zone.

```
! Assign the internal LAN interface to the PRIVATE zone
R1(config)# interface GigabitEthernet 0/0
R1(config-if)# zone-member security PRIVATE

! Assign the internet-facing interface to the PUBLIC zone
R1(config)# interface Serial 0/0/0
R1(config-if)# zone-member security PUBLIC
```

---
#### Activation and Results
The moment these commands are entered, the entire ZPF policy becomes active. The result of the 5-step configuration is:

*   Traffic from `PRIVATE` to `PUBLIC` that matches the `HTTP-TRAFFIC` class-map (HTTP, HTTPS, DNS) will be **inspected**.
*   Because the traffic is inspected, the **return traffic** for those established sessions will be **automatically allowed** back from `PUBLIC` to `PRIVATE`.
*   Any other traffic initiated from `PRIVATE` to `PUBLIC` will be **dropped** (by the implicit `class-default` action).
*   Any new traffic initiated from `PUBLIC` to `PRIVATE` will be **dropped** (because no policy exists for the `PUBLIC -> PRIVATE` zone-pair).


---

# 16.3.7: Verify a ZPF Configuration

After configuring a ZPF, you must verify that it is working correctly. There are several `show` commands to inspect the configuration and monitor live traffic.

#### 1. Verifying the Full Configuration
The `show running-config` command displays the entire ZPF configuration in a logical order.

*   **Command:** `R1# show run | begin class-map`
*   **What to Look For:**
    *   The configuration follows the logical structure: `class-map` -> `policy-map` -> `zones` & `zone-pair` -> `interfaces`.
    *   Crucially, you can see the `class class-default` at the end of the `policy-map`, which has an implicit `drop` action. This is what blocks all traffic that you did not explicitly permit.

---
#### 2. Viewing Active Sessions and Statistics (Most Useful Command)
This is the most powerful command to see the firewall in action, showing live session data and packet counters.

*   **Command:** `R1# show policy-map type inspect zone-pair sessions`
*   **Key Information in the Output:**
    *   **Packet Counters:** Shows how many packets have matched each rule inside your `class-map` (e.g., `match protocol http`). This confirms your traffic classification is working.
    *   **Established Sessions:** Displays the live state table. You can see the source/destination IPs and ports for each connection being actively tracked by the `inspect` action.
    *   **Drop Counters:** The counter under `class-default` shows how many packets were dropped because they didn't match any of your `permit` or `inspect` rules (e.g., the ICMP pings in the example).

---
#### 3. Component-Specific Verification Commands
These commands allow you to quickly check specific parts of the ZPF configuration.

| Command | What it Shows |
| :--- | :--- |
| `show class-map type inspect` | Displays the configuration of all `inspect` type class-maps. |
| `show zone security` | Lists all security zones and the interfaces assigned to each. |
| `show zone-pair security` | Shows the configured zone-pairs, their source/destination zones, and the attached service-policy. |
| `show policy-map type inspect` | Displays the configuration of policy-maps, showing which class-maps are included and the action (`inspect`, `drop`, `pass`) for each. |


---

# 16.3.9: ZPF Configuration Considerations

This section summarizes the fundamental rules and behaviors to remember when configuring a Zone-Based Policy Firewall.

| Rule / Consideration | Explanation / Consequence |
| :--- | :--- |
| **Intra-Zone Traffic** | Traffic between interfaces that are members of the **same zone** is always **permitted** by default. The router does not apply any firewall policy to it. |
| **One Zone per Interface** | An interface can only be a member of **one** security zone. You cannot assign it to multiple zones. |
| **Coexistence with Classic Firewall**| ZPF and the older Classic Firewall (`ip inspect`) can run on the same router, but a single interface **cannot** be configured for both. You must remove the `ip inspect` command before adding a `zone-member` command. |
| **Zone to Non-Zone Traffic is Dropped** | Traffic is **always dropped** if it tries to flow between an interface that is a zone member and an interface that is not. **WARNING:** This means assigning the first interface to a zone will cause a temporary service interruption until its corresponding peer interface is also assigned to a zone. |
| **Inter-Zone Traffic is Denied by Default** | This is the core security principle of ZPF. Traffic moving between **different zones** is **dropped** by default. You must create an explicit policy on a zone-pair to permit it. |
| **The Self Zone Exception**| By default, traffic to or from the router itself (the **self zone**) is **permitted**. To protect the router (e.g., restrict SSH), you must create an explicit policy that uses the `self` zone as a source or destination. |